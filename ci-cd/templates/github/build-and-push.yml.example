name: ðŸ”§ Build and Push Docker Image

# This is an EXAMPLE workflow file
# To use it:
# 1. Copy this file to .github/workflows/build-and-push.yml (remove .example)
# 2. Create .ci.env from .ci.env.template and set IMAGE_VERSION
# 3. Add DOCKER_USERNAME and DOCKER_PASSWORD to GitHub repository secrets
# 4. Add IMAGE_NAME to GitHub repository variables (Settings â†’ Secrets and variables â†’ Actions â†’ Variables)
# 5. Customize the trigger conditions below as needed

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      image_version:
        description: 'Image version/tag to build'
        required: true
        default: 'latest'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ vars.IMAGE_NAME }}
    
    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ§ª Load CI Environment Variables
        run: |
          if [ -f .ci.env ]; then
            while IFS='=' read -r key value
            do
              # Skip comments and empty lines
              [[ $key =~ ^#.*$ ]] && continue
              [[ -z $key ]] && continue
              echo "$key=$value" >> $GITHUB_ENV
            done < .ci.env
          else
            echo "âš ï¸  .ci.env not found, using defaults"
          fi
      
      - name: ðŸ” Debug Environment Values
        run: |
          echo "IMAGE_NAME=$IMAGE_NAME"
          echo "IMAGE_VERSION=$IMAGE_VERSION"
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      # Uncomment for GitHub Container Registry
      # - name: ðŸ” Login to GitHub Container Registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ghcr.io
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸš€ Build and Push Docker Image
        run: |
          docker buildx build --load \
            --build-arg IMAGE_TAG=$IMAGE_TAG \
            -t $IMAGE_NAME:$IMAGE_TAG \
            .
          docker push $IMAGE_NAME:$IMAGE_TAG

      - name: âœ… Build Summary
        run: |
          echo "### ðŸŽ‰ Docker Image Built Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \"`$IMAGE_NAME:$IMAGE_TAG`\"" >> $GITHUB_STEP_SUMMARY
          echo "**Also tagged as:** \"`$IMAGE_NAME:latest`\"" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Pull the image: \"`docker pull $IMAGE_NAME:$IMAGE_TAG`\"" >> $GITHUB_STEP_SUMMARY
          echo "2. Run locally: \"`docker run -p 8000:8000 $IMAGE_NAME:$IMAGE_TAG`\"" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy to production server" >> $GITHUB_STEP_SUMMARY
