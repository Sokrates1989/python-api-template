# GitLab CI/CD Pipeline for Azure Container Instances Deployment

stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

before_script:
  - |
    if [ -f .ci.env ]; then
      export $(grep -v '^#' .ci.env | grep -v '^$' | xargs)
    fi

build-image:
  stage: build
  image: docker:24-cli
  services:
    - docker:24-dind
  before_script:
    - |
      if [ -f .ci.env ]; then
        export $(grep -v '^#' .ci.env | grep -v '^$' | xargs)
      fi
  script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        IMAGE_TAG="$CI_COMMIT_TAG"
      elif [ -n "$IMAGE_VERSION" ]; then
        IMAGE_TAG="$IMAGE_VERSION"
      else
        IMAGE_TAG="${CI_COMMIT_SHORT_SHA}"
      fi
    
    - |
      docker buildx build \
        --build-arg PYTHON_VERSION="${PYTHON_VERSION:-3.13}-slim" \
        --build-arg IMAGE_TAG="$IMAGE_TAG" \
        -t "$IMAGE_NAME:$IMAGE_TAG" \
        -t "$IMAGE_NAME:latest" \
        -f "${DOCKERFILE_PATH:-Dockerfile}" \
        .
    
    - docker push "$IMAGE_NAME:$IMAGE_TAG"
    - docker push "$IMAGE_NAME:latest"
    
    - echo "IMAGE_TAG=$IMAGE_TAG" > build.env
  artifacts:
    reports:
      dotenv: build.env
  only:
    - main
    - master
    - dev
    - tags
  tags:
    - docker

deploy-azure:
  stage: deploy
  image: mcr.microsoft.com/azure-cli:latest
  dependencies:
    - build-image
  before_script:
    - |
      if [ -f .ci.env ]; then
        export $(grep -v '^#' .ci.env | grep -v '^$' | xargs)
      fi
  script:
    - echo "Deploying to Azure Container Instances..."
    
    # Login to Azure using service principal
    - |
      az login --service-principal \
        -u $AZURE_CLIENT_ID \
        -p $AZURE_CLIENT_SECRET \
        --tenant $AZURE_TENANT_ID
    
    # Check if container instance exists and delete it
    - |
      if az container show \
        --resource-group $AZURE_RESOURCE_GROUP \
        --name $AZURE_CONTAINER_NAME &>/dev/null; then
        echo "Deleting existing container instance..."
        az container delete \
          --resource-group $AZURE_RESOURCE_GROUP \
          --name $AZURE_CONTAINER_NAME \
          --yes
      fi
    
    # Create new container instance
    - |
      az container create \
        --resource-group $AZURE_RESOURCE_GROUP \
        --name $AZURE_CONTAINER_NAME \
        --image $IMAGE_NAME:$IMAGE_TAG \
        --dns-name-label $AZURE_CONTAINER_NAME \
        --ports 8000 \
        --location $AZURE_LOCATION \
        --environment-variables \
          PORT=8000 \
          DEBUG=false \
        --secure-environment-variables \
          DATABASE_URL="$PROD_DATABASE_URL" \
          REDIS_URL="$PROD_REDIS_URL" \
          ADMIN_API_KEY="$PROD_ADMIN_API_KEY" \
        --registry-login-server docker.io \
        --registry-username $DOCKER_USERNAME \
        --registry-password $DOCKER_PASSWORD
    
    # Get FQDN
    - |
      FQDN=$(az container show \
        --resource-group $AZURE_RESOURCE_GROUP \
        --name $AZURE_CONTAINER_NAME \
        --query ipAddress.fqdn \
        --output tsv)
      
      echo "âœ… Deployment successful!"
      echo "   Container: $AZURE_CONTAINER_NAME"
      echo "   Resource Group: $AZURE_RESOURCE_GROUP"
      echo "   Image: $IMAGE_NAME:$IMAGE_TAG"
      echo "   URL: http://${FQDN}:8000"
  only:
    - main
    - master
  when: manual
  environment:
    name: production
    url: http://$AZURE_CONTAINER_NAME.$AZURE_LOCATION.azurecontainer.io:8000
  tags:
    - docker
