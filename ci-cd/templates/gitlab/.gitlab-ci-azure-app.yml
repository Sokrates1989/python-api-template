# GitLab CI/CD Pipeline for Azure App Service Deployment

stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

before_script:
  - |
    if [ -f .ci.env ]; then
      export $(grep -v '^#' .ci.env | grep -v '^$' | xargs)
    fi

build-image:
  stage: build
  image: docker:24-cli
  services:
    - docker:24-dind
  before_script:
    - |
      if [ -f .ci.env ]; then
        export $(grep -v '^#' .ci.env | grep -v '^$' | xargs)
      fi
  script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        IMAGE_TAG="$CI_COMMIT_TAG"
      elif [ -n "$IMAGE_VERSION" ]; then
        IMAGE_TAG="$IMAGE_VERSION"
      else
        IMAGE_TAG="${CI_COMMIT_SHORT_SHA}"
      fi
    
    - |
      docker buildx build \
        --build-arg PYTHON_VERSION="${PYTHON_VERSION:-3.13}-slim" \
        --build-arg IMAGE_TAG="$IMAGE_TAG" \
        -t "$IMAGE_NAME:$IMAGE_TAG" \
        -t "$IMAGE_NAME:latest" \
        -f "${DOCKERFILE_PATH:-Dockerfile}" \
        .
    
    - docker push "$IMAGE_NAME:$IMAGE_TAG"
    - docker push "$IMAGE_NAME:latest"
    
    - echo "IMAGE_TAG=$IMAGE_TAG" > build.env
  artifacts:
    reports:
      dotenv: build.env
  only:
    - main
    - master
    - dev
    - tags
  tags:
    - docker

deploy-azure:
  stage: deploy
  image: mcr.microsoft.com/azure-cli:latest
  dependencies:
    - build-image
  before_script:
    - |
      if [ -f .ci.env ]; then
        export $(grep -v '^#' .ci.env | grep -v '^$' | xargs)
      fi
  script:
    - echo "Deploying to Azure App Service..."
    
    # Login to Azure using service principal
    - |
      az login --service-principal \
        -u $AZURE_CLIENT_ID \
        -p $AZURE_CLIENT_SECRET \
        --tenant $AZURE_TENANT_ID
    
    # Configure App Service to use Docker container
    - |
      az webapp config container set \
        --name $AZURE_APP_NAME \
        --resource-group $AZURE_RESOURCE_GROUP \
        --docker-custom-image-name $IMAGE_NAME:$IMAGE_TAG \
        --docker-registry-server-url https://index.docker.io \
        --docker-registry-server-user $DOCKER_USERNAME \
        --docker-registry-server-password $DOCKER_PASSWORD
    
    # Configure environment variables
    - |
      az webapp config appsettings set \
        --name $AZURE_APP_NAME \
        --resource-group $AZURE_RESOURCE_GROUP \
        --settings \
          PORT=8000 \
          DEBUG=false \
          DATABASE_URL="$PROD_DATABASE_URL" \
          REDIS_URL="$PROD_REDIS_URL" \
          ADMIN_API_KEY="$PROD_ADMIN_API_KEY" \
          WEBSITES_PORT=8000
    
    # Restart the app
    - |
      az webapp restart \
        --name $AZURE_APP_NAME \
        --resource-group $AZURE_RESOURCE_GROUP
    
    # Get URL
    - |
      URL=$(az webapp show \
        --name $AZURE_APP_NAME \
        --resource-group $AZURE_RESOURCE_GROUP \
        --query defaultHostName \
        --output tsv)
      
      echo "âœ… Deployment successful!"
      echo "   App Service: $AZURE_APP_NAME"
      echo "   Resource Group: $AZURE_RESOURCE_GROUP"
      echo "   Image: $IMAGE_NAME:$IMAGE_TAG"
      echo "   URL: https://${URL}"
  only:
    - main
    - master
  when: manual
  environment:
    name: production
    url: https://$AZURE_APP_NAME.azurewebsites.net
  tags:
    - docker
