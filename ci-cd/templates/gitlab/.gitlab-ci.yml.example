# GitLab CI/CD Pipeline Example
# This is an EXAMPLE pipeline configuration
# To use it:
# 1. Copy this file to .gitlab-ci.yml (remove .example)
# 2. Create .ci.env from .ci.env.template and configure it
# 3. Add DOCKER_USERNAME and DOCKER_PASSWORD to GitLab CI/CD variables
# 4. Customize stages and jobs as needed

stages:
  - build
  - deploy

variables:
  # Docker image settings
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Load environment variables from .ci.env
before_script:
  - |
    if [ -f .ci.env ]; then
      export $(grep -v '^#' .ci.env | grep -v '^$' | xargs)
    fi

build-image:
  stage: build
  image: docker:24-cli
  services:
    - docker:24-dind
  before_script:
    - |
      if [ -f .ci.env ]; then
        export $(grep -v '^#' .ci.env | grep -v '^$' | xargs)
      fi
    - echo "IMAGE_NAME=$IMAGE_NAME"
    - echo "IMAGE_VERSION=$IMAGE_VERSION"
    - echo "PYTHON_VERSION=$PYTHON_VERSION"
  script:
    # Login to Docker registry
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    
    # Determine image tag
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        IMAGE_TAG="$CI_COMMIT_TAG"
      elif [ -n "$IMAGE_VERSION" ]; then
        IMAGE_TAG="$IMAGE_VERSION"
      else
        IMAGE_TAG="${CI_COMMIT_SHORT_SHA}"
      fi
    
    - echo "Building image with tag: $IMAGE_TAG"
    
    # Build and push image
    - |
      docker buildx build \
        --build-arg PYTHON_VERSION="${PYTHON_VERSION:-3.13}-slim" \
        --build-arg IMAGE_TAG="$IMAGE_TAG" \
        -t "$IMAGE_NAME:$IMAGE_TAG" \
        -t "$IMAGE_NAME:latest" \
        -f "${DOCKERFILE_PATH:-Dockerfile}" \
        .
    
    - docker push "$IMAGE_NAME:$IMAGE_TAG"
    - docker push "$IMAGE_NAME:latest"
    
    - echo "âœ… Image pushed successfully!"
    - echo "   $IMAGE_NAME:$IMAGE_TAG"
    - echo "   $IMAGE_NAME:latest"
  only:
    - main
    - master
    - tags
  tags:
    - docker

# Optional: Deploy to production server
# Uncomment and configure as needed
# deploy-production:
#   stage: deploy
#   image: alpine:latest
#   before_script:
#     - apk add --no-cache openssh-client
#     - eval $(ssh-agent -s)
#     - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
#     - mkdir -p ~/.ssh
#     - chmod 700 ~/.ssh
#     - ssh-keyscan $DEPLOY_SERVER >> ~/.ssh/known_hosts
#   script:
#     - |
#       ssh $DEPLOY_USER@$DEPLOY_SERVER << 'EOF'
#         cd $DEPLOY_PATH
#         docker pull $IMAGE_NAME:latest
#         docker compose down
#         docker compose up -d
#       EOF
#   only:
#     - main
#     - master
#   when: manual
#   environment:
#     name: production
#     url: https://your-production-url.com
