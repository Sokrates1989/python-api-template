name: ðŸ”§ Build and Push Docker Image

# This is an EXAMPLE workflow file
# To use it:
# 1. Copy this file to .github/workflows/build-and-push.yml (remove .example)
# 2. Create .ci.env from .ci.env.template and configure it
# 3. Add DOCKER_USERNAME and DOCKER_PASSWORD to GitHub repository secrets
# 4. Customize the trigger conditions below as needed

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      image_version:
        description: 'Image version/tag to build'
        required: true
        default: 'latest'

env:
  # These will be loaded from .ci.env
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/api-name
  
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ§ª Load CI Environment Variables
        run: |
          if [ -f .ci.env ]; then
            while IFS='=' read -r key value
            do
              # Skip comments and empty lines
              [[ $key =~ ^#.*$ ]] && continue
              [[ -z $key ]] && continue
              echo "$key=$value" >> $GITHUB_ENV
            done < .ci.env
          else
            echo "âš ï¸  .ci.env not found, using defaults"
          fi
      
      - name: ðŸ” Debug Environment Values
        run: |
          echo "IMAGE_NAME=$IMAGE_NAME"
          echo "IMAGE_VERSION=$IMAGE_VERSION"
          echo "PYTHON_VERSION=$PYTHON_VERSION"
          echo "DOCKERFILE_PATH=$DOCKERFILE_PATH"
          
      - name: ðŸ·ï¸ Determine Image Tag
        id: image_tag
        run: |
          # Use manual input if provided
          if [ -n "${{ github.event.inputs.image_version }}" ]; then
            echo "tag=${{ github.event.inputs.image_version }}" >> $GITHUB_OUTPUT
          # Use git tag if available
          elif [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          # Use IMAGE_VERSION from .ci.env
          elif [ -n "$IMAGE_VERSION" ]; then
            echo "tag=$IMAGE_VERSION" >> $GITHUB_OUTPUT
          # Fallback to commit SHA
          else
            echo "tag=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          fi
          
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      # Uncomment for GitHub Container Registry
      # - name: ðŸ” Login to GitHub Container Registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ghcr.io
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸš€ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH || 'Dockerfile' }}
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.image_tag.outputs.tag }}
            ${{ env.IMAGE_NAME }}:latest
          build-args: |
            PYTHON_VERSION=${{ env.PYTHON_VERSION || '3.13' }}-slim
            IMAGE_TAG=${{ steps.image_tag.outputs.tag }}
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: âœ… Build Summary
        run: |
          echo "### ðŸŽ‰ Docker Image Built Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.IMAGE_NAME }}:${{ steps.image_tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Also tagged as:** \`${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Pull the image: \`docker pull ${{ env.IMAGE_NAME }}:${{ steps.image_tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Run locally: \`docker run -p 8000:8000 ${{ env.IMAGE_NAME }}:${{ steps.image_tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy to production server" >> $GITHUB_STEP_SUMMARY
